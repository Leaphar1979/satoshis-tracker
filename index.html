<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Satoshis Tracker â€“ BTC Pair Trades</title>

  <!-- iPhone PWA settings -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Satoshis Tracker" />

  <!-- App Icon -->
  <link rel="icon" type="image/png" href="icon-512.png" />
  <link rel="apple-touch-icon" href="icon-512.png" />

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: #050816;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 16px;
      text-align: center;
    }

    .card {
      background: #111827;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 12px;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e33;
    }

    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      width: 100%;
    }

    .btn-secondary {
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.85rem;
    }

    .summary-item {
      padding: 8px 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      white-space: nowrap;
      text-align: right;
    }

    th:first-child, td:first-child { text-align: left; }

    .tag-win { color: #22c55e; font-weight: 600; }
    .tag-loss { color: #f97316; font-weight: 600; }

    .footer {
      margin-top: 16px;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- BIG ICON -->
  <div style="text-align:center; margin-bottom:10px;">
    <img src="icon-512.png" alt="logo" style="width:120px; height:120px; border-radius:20px;">
  </div>

  <h1>Satoshis Tracker â€“ BTC Pair Trades</h1>
  <div class="subtitle">Record your trades and track your satoshi growth.</div>

  <!-- NEW TRADE CARD -->
  <div class="card">
    <h2>New trade</h2>

    <form id="tradeForm">
      <div>
        <label for="openDate">Open date (DD/MM/YYYY)</label>
        <input type="text" id="openDate" placeholder="03/12/2025" required>
      </div>

      <div>
        <label for="closeDate">Close date (DD/MM/YYYY)</label>
        <input type="text" id="closeDate" placeholder="05/12/2025" required>
      </div>

      <div>
        <label for="pair">Pair (auto â†’ XXX/BTC)</label>
        <input type="text" id="pair" placeholder="xrpbtc / xrp / XRP/BTC" required>
      </div>

      <div>
        <label for="qty">Alt quantity</label>
        <input type="number" step="0.00000001" id="qty" required>
      </div>

      <div>
        <label for="entry">Entry price (BTC)</label>
        <input type="number" step="0.00000001" id="entry" required>
      </div>

      <div>
        <label for="exit">Exit price (BTC)</label>
        <input type="number" step="0.00000001" id="exit" required>
      </div>

      <div>
        <label for="fee">Fee (BTC) [optional]</label>
        <input type="number" step="0.00000001" id="fee" placeholder="0 if paid in BNB">
      </div>

      <div>
        <button class="btn-primary">Add trade</button>
      </div>
    </form>
  </div>

  <!-- SUMMARY CARD -->
  <div class="card">
    <h2>Summary</h2>

    <div class="summary">
      <div class="summary-item" id="sumTotalTrades">Trades: 0</div>
      <div class="summary-item" id="sumWins">Win rate: 0%</div>
      <div class="summary-item" id="sumBtcResult">BTC Result: 0</div>
      <div class="summary-item" id="sumAvgRoi">Avg ROI: 0%</div>
    </div>

    <div style="margin-top:12px;">
      <button class="btn-secondary" id="btnTogglePairs">Pairs summary</button>
    </div>
  </div>

  <!-- PAIRS SUMMARY -->
  <div class="card" id="cardPairs" style="display:none;">
    <h2>Pairs summary</h2>
    <div class="table-wrapper">
      <table id="pairsTable">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Trades</th>
            <th>Wins</th>
            <th>Total BTC</th>
            <th>Avg ROI %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- TRADE HISTORY -->
  <div class="card">
    <h2>Trade history</h2>
    <div class="table-wrapper">
      <table id="tradesTable">
        <thead>
          <tr>
            <th>Open</th>
            <th>Close</th>
            <th>Pair</th>
            <th>Qty</th>
            <th>Entry (BTC)</th>
            <th>Exit (BTC)</th>
            <th>BTC In</th>
            <th>BTC Out</th>
            <th>BTC Result</th>
            <th>ROI %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    Data stored locally (localStorage). You are farming sats. ðŸš€
  </div>

  <script>
    const STORAGE_KEY = "btcPairTrades";

    // ---------- Helpers: format ----------
    function formatNumber(n, d = 8) { return Number(n).toFixed(d); }
    function formatPercent(n) { return Number(n).toFixed(2) + "%"; }

    // ---------- Normalize: DATE ----------
    // Accepts: 03122025, 3/12/2025, 03-12-25, 03.12.2025, 2025-12-03
    function normalizeDate(input) {
      const s = String(input || "").trim();
      if (!s) return null;

      // If looks like YYYY-MM-DD or YYYY/MM/DD
      const isoLike = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if (isoLike) {
        const y = parseInt(isoLike[1], 10);
        const m = parseInt(isoLike[2], 10);
        const d = parseInt(isoLike[3], 10);
        if (!isValidYMD(y, m, d)) return null;
        return toDDMMYYYY(d, m, y);
      }

      // Extract digits only
      const digits = s.replace(/\D/g, "");
      if (digits.length === 8) {
        // Decide between DDMMYYYY and YYYYMMDD
        const first4 = parseInt(digits.slice(0,4), 10);
        if (first4 >= 1900 && first4 <= 2099) {
          const y = first4;
          const m = parseInt(digits.slice(4,6), 10);
          const d = parseInt(digits.slice(6,8), 10);
          if (!isValidYMD(y, m, d)) return null;
          return toDDMMYYYY(d, m, y);
        } else {
          const d = parseInt(digits.slice(0,2), 10);
          const m = parseInt(digits.slice(2,4), 10);
          const y = parseInt(digits.slice(4,8), 10);
          if (!isValidYMD(y, m, d)) return null;
          return toDDMMYYYY(d, m, y);
        }
      }

      if (digits.length === 6) {
        // DDMMYY -> 20YY
        const d = parseInt(digits.slice(0,2), 10);
        const m = parseInt(digits.slice(2,4), 10);
        const y = 2000 + parseInt(digits.slice(4,6), 10);
        if (!isValidYMD(y, m, d)) return null;
        return toDDMMYYYY(d, m, y);
      }

      // If typed with separators like D/M/YYYY
      const dmY = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2}|\d{4})$/);
      if (dmY) {
        const d = parseInt(dmY[1], 10);
        const m = parseInt(dmY[2], 10);
        let y = parseInt(dmY[3], 10);
        if (String(dmY[3]).length === 2) y = 2000 + y;
        if (!isValidYMD(y, m, d)) return null;
        return toDDMMYYYY(d, m, y);
      }

      return null;
    }

    function toDDMMYYYY(d, m, y) {
      const dd = String(d).padStart(2, "0");
      const mm = String(m).padStart(2, "0");
      const yyyy = String(y).padStart(4, "0");
      return `${dd}/${mm}/${yyyy}`;
    }

    function isValidYMD(y, m, d) {
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;
      if (y < 1900 || y > 2099) return false;
      if (m < 1 || m > 12) return false;
      if (d < 1 || d > 31) return false;
      // basic month-day check
      const daysInMonth = new Date(y, m, 0).getDate();
      return d <= daysInMonth;
    }

    // ---------- Normalize: PAIR ----------
    // Accepts: xrpbtc, xrp/btc, xrp, XRPbtc,  XRP / BTC  -> XRP/BTC
    function normalizePair(input) {
      let s = String(input || "").trim().toUpperCase();
      if (!s) return null;

      s = s.replace(/\s+/g, "");
      s = s.replace(/-/g, "/");

      if (s.includes("/")) {
        const [base, quote] = s.split("/");
        if (!base) return null;
        // force quote BTC
        return `${base}/BTC`;
      }

      // no slash
      if (s === "BTC") return null;

      if (s.endsWith("BTC") && s.length > 3) {
        const base = s.slice(0, -3);
        if (!base) return null;
        return `${base}/BTC`;
      }

      // just base
      return `${s}/BTC`;
    }

    // ---------- Storage ----------
    function loadTrades() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }

    function saveTrades(t) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(t));
    }

    // ---------- Migration (preserve old trades) ----------
    function migrateTradesIfNeeded(trades) {
      // Old structure: { date, pair, qty, entry, exit, btcIn, btcOut, btcResult, roi }
      // New: { openDate, closeDate, pair, ... }
      let changed = false;

      const migrated = trades.map(t => {
        const copy = { ...t };

        // open/close
        if (!copy.openDate || !copy.closeDate) {
          const legacyDate = copy.date || copy.data; // be generous
          if (legacyDate && (!copy.openDate || !copy.closeDate)) {
            copy.openDate = copy.openDate || legacyDate;
            copy.closeDate = copy.closeDate || legacyDate;
            changed = true;
          }
        }

        // pair normalization (safe)
        if (copy.pair && typeof copy.pair === "string") {
          const np = normalizePair(copy.pair);
          if (np && np !== copy.pair) {
            copy.pair = np;
            changed = true;
          }
        }

        // date normalization (safe)
        if (copy.openDate) {
          const nd = normalizeDate(copy.openDate) || copy.openDate;
          if (nd !== copy.openDate) { copy.openDate = nd; changed = true; }
        }
        if (copy.closeDate) {
          const nd = normalizeDate(copy.closeDate) || copy.closeDate;
          if (nd !== copy.closeDate) { copy.closeDate = nd; changed = true; }
        }

        return copy;
      });

      if (changed) saveTrades(migrated);
      return migrated;
    }

    // ---------- Render ----------
    function renderTrades() {
      let trades = loadTrades();
      trades = migrateTradesIfNeeded(trades);

      let total = 0, wins = 0;
      const tbody = document.querySelector("#tradesTable tbody");
      tbody.innerHTML = "";

      trades.forEach((t) => {
        total += Number(t.btcResult || 0);
        if (Number(t.btcResult || 0) > 0) wins++;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.openDate || "â€”"}</td>
          <td>${t.closeDate || "â€”"}</td>
          <td>${t.pair || "â€”"}</td>
          <td>${formatNumber(t.qty || 0, 4)}</td>
          <td>${formatNumber(t.entry || 0)}</td>
          <td>${formatNumber(t.exit || 0)}</td>
          <td>${formatNumber(t.btcIn || 0)}</td>
          <td>${formatNumber(t.btcOut || 0)}</td>
          <td class="${Number(t.btcResult || 0) >= 0 ? "tag-win" : "tag-loss"}">${formatNumber(t.btcResult || 0)}</td>
          <td class="${Number(t.roi || 0) >= 0 ? "tag-win" : "tag-loss"}">${formatPercent(t.roi || 0)}</td>
        `;
        tbody.appendChild(row);
      });

      const totalTrades = trades.length;
      const avgROI = totalTrades ? trades.reduce((s, t) => s + Number(t.roi || 0), 0) / totalTrades : 0;

      document.getElementById("sumTotalTrades").textContent = `Trades: ${totalTrades}`;
      document.getElementById("sumWins").textContent = `Win rate: ${(wins / totalTrades * 100 || 0).toFixed(2)}%`;
      document.getElementById("sumBtcResult").textContent = `BTC Result: ${formatNumber(total)}`;
      document.getElementById("sumAvgRoi").textContent = `Avg ROI: ${avgROI.toFixed(2)}%`;

      renderPairSummary(trades);
    }

    function renderPairSummary(trades) {
      const table = document.querySelector("#pairsTable tbody");
      table.innerHTML = "";

      const groups = {};
      trades.forEach(t => {
        const p = t.pair || "â€”";
        if (!groups[p]) groups[p] = { trades: 0, wins: 0, btc: 0, roi: 0 };
        groups[p].trades++;
        groups[p].btc += Number(t.btcResult || 0);
        groups[p].roi += Number(t.roi || 0);
        if (Number(t.btcResult || 0) > 0) groups[p].wins++;
      });

      const keys = Object.keys(groups);
      keys.sort((a,b) => groups[b].btc - groups[a].btc);

      keys.forEach(p => {
        const g = groups[p];
        const avg = g.trades ? (g.roi / g.trades) : 0;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p}</td>
          <td>${g.trades}</td>
          <td>${g.wins}</td>
          <td class="${g.btc >= 0 ? "tag-win" : "tag-loss"}">${formatNumber(g.btc)}</td>
          <td class="${avg >= 0 ? "tag-win" : "tag-loss"}">${formatPercent(avg)}</td>
        `;
        table.appendChild(row);
      });

      if (!keys.length) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5" style="text-align:center; color:#6b7280;">No trades</td>`;
        table.appendChild(row);
      }
    }

    // ---------- UI auto-normalize on blur ----------
    function attachAutoNormalize() {
      const openEl = document.getElementById("openDate");
      const closeEl = document.getElementById("closeDate");
      const pairEl = document.getElementById("pair");

      const fixDate = (el) => {
        const nd = normalizeDate(el.value);
        if (nd) el.value = nd;
      };

      openEl.addEventListener("blur", () => fixDate(openEl));
      closeEl.addEventListener("blur", () => fixDate(closeEl));

      pairEl.addEventListener("blur", () => {
        const np = normalizePair(pairEl.value);
        if (np) pairEl.value = np;
      });
    }

    // ---------- Form submit ----------
    document.getElementById("tradeForm").addEventListener("submit", e => {
      e.preventDefault();

      // Normalize inputs (accept messy input)
      const openRaw = document.getElementById("openDate").value;
      const closeRaw = document.getElementById("closeDate").value;
      const pairRaw = document.getElementById("pair").value;

      const openDate = normalizeDate(openRaw);
      const closeDate = normalizeDate(closeRaw);
      const pair = normalizePair(pairRaw);

      if (!openDate) {
        alert("Invalid open date. Use something like 03/12/2025 (or 03122025).");
        return;
      }
      if (!closeDate) {
        alert("Invalid close date. Use something like 05/12/2025 (or 05122025).");
        return;
      }
      if (!pair) {
        alert("Invalid pair. Examples: XRP/BTC, xrpbtc, xrp");
        return;
      }

      const qty = parseFloat(document.getElementById("qty").value);
      const entry = parseFloat(document.getElementById("entry").value);
      const exit = parseFloat(document.getElementById("exit").value);
      const fee = parseFloat(document.getElementById("fee").value || 0);

      if (!Number.isFinite(qty) || !Number.isFinite(entry) || !Number.isFinite(exit)) {
        alert("Fill quantity, entry and exit with valid numbers.");
        return;
      }

      const btcIn = qty * entry;
      const btcOut = qty * exit;
      const btcResult = btcOut - btcIn - (Number.isFinite(fee) ? fee : 0);
      const roi = btcIn ? (btcResult / btcIn) * 100 : 0;

      const trades = migrateTradesIfNeeded(loadTrades());
      trades.push({
        openDate,
        closeDate,
        pair,
        qty,
        entry,
        exit,
        fee: Number.isFinite(fee) ? fee : 0,
        btcIn,
        btcOut,
        btcResult,
        roi
      });

      saveTrades(trades);
      renderTrades();
      e.target.reset();
    });

    // ---------- Toggle pairs ----------
    document.getElementById("btnTogglePairs").addEventListener("click", () => {
      const c = document.getElementById("cardPairs");
      c.style.display = c.style.display === "none" ? "block" : "none";
    });

    // init
    attachAutoNormalize();
    renderTrades();
  </script>
</body>
</html>
