<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Satoshis Tracker ‚Äì BTC Pair Trades</title>

  <!-- iPhone PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Satoshis Tracker" />
  <meta name="theme-color" content="#050816" />

  <!-- App Icon -->
  <link rel="icon" type="image/png" href="icon-512.png" />
  <link rel="apple-touch-icon" href="icon-512.png" />

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      margin:0;
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background:#050816;
      color:#e5e7eb;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
      text-align:center;
    }
    .brand img{
      width:120px;height:120px;border-radius:22px;
      box-shadow: 0 10px 28px rgba(0,0,0,.55);
    }
    h1{
      margin:0;
      font-size:1.45rem;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      margin-top:4px;
      font-size:.9rem;
      color:#9ca3af;
      max-width: 28rem;
    }

    .card{
      background:#111827;
      border-radius:16px;
      padding:16px;
      margin:14px 0;
      box-shadow: 0 10px 28px rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.04);
    }
    .card h2{
      margin:0 0 12px 0;
      font-size:1.05rem;
      letter-spacing:.2px;
    }

    /* Form */
    form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:.82rem;
      color:#9ca3af;
      margin-bottom:6px;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:.95rem;
      height:44px;
    }
    input:focus{
      outline:none;
      border-color:#22c55e;
      box-shadow: 0 0 0 2px rgba(34,197,94,.18);
    }

    .span-2{ grid-column: 1 / -1; }

    .btn{
      height:44px;
      padding: 0 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:.95rem;
      font-weight:650;
      transition: transform .05s ease;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(.98); }

    .btn-primary{
      background:#22c55e;
      color:#022c22;
      width:100%;
    }
    .btn-secondary{
      background:#0b1223;
      color:#e5e7eb;
      border:1px solid #374151;
    }
    .btn-danger{
      background:#ef4444;
      color:white;
      border: none;
    }

    /* Summary pills */
    .summary{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:.88rem;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      color:#e5e7eb;
    }

    /* Actions row */
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    /* Tables */
    .table-wrap{ width:100%; overflow-x:auto; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
      min-width: 720px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:right;
      white-space:nowrap;
    }
    th{
      color:#cbd5e1;
      font-weight:650;
      background:#0b1223;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child, td:first-child{ text-align:left; }
    tr:nth-child(even) td{ background: rgba(2,6,23,.35); }

    .tag-win{ color:#22c55e; font-weight:700; }
    .tag-loss{ color:#f97316; font-weight:700; }

    /* Trash icon button */
    .trash{
      background: transparent;
      border: 1px solid rgba(255,255,255,.10);
      color:#e5e7eb;
      border-radius: 12px;
      width: 38px;
      height: 34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size: 16px;
    }
    .trash:active{ transform: scale(.98); }
    .trash:hover{ border-color: rgba(255,255,255,.18); }

    .footer{
      text-align:center;
      color:#6b7280;
      font-size:.78rem;
      margin: 18px 0 6px;
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      form{ grid-template-columns: 1fr 1fr; }
      h1{ font-size:1.35rem; }
      .brand img{ width:110px;height:110px; }
      table{ font-size:.80rem; }
    }
  </style>
</head>
<body>

  <div class="brand">
    <img src="icon-512.png" alt="Satoshis Tracker">
    <div>
      <h1>Satoshis Tracker ‚Äì BTC Pair Trades</h1>
      <p class="subtitle">Record your trades and track your satoshi growth.</p>
    </div>
  </div>

  <!-- NEW TRADE -->
  <div class="card">
    <h2>New trade</h2>

    <form id="tradeForm" autocomplete="off">
      <div class="field">
        <label for="openDate">Open date</label>
        <input id="openDate" type="text" inputmode="numeric" placeholder="DD/MM/YYYY" required />
      </div>

      <div class="field">
        <label for="closeDate">Close date</label>
        <input id="closeDate" type="text" inputmode="numeric" placeholder="DD/MM/YYYY" required />
      </div>

      <div class="field">
        <label for="pair">Pair</label>
        <input id="pair" type="text" placeholder="XRP/BTC" required />
      </div>

      <div class="field">
        <label for="altQty">Alt quantity</label>
        <input id="altQty" type="number" step="0.00000001" required />
      </div>

      <div class="field">
        <label for="entryPrice">Entry price (BTC)</label>
        <input id="entryPrice" type="number" step="0.00000001" required />
      </div>

      <div class="field">
        <label for="exitPrice">Exit price (BTC)</label>
        <input id="exitPrice" type="number" step="0.00000001" required />
      </div>

      <div class="field span-2">
        <label for="feeBtc">Fee (BTC)</label>
        <input id="feeBtc" type="number" step="0.00000001" placeholder="0 if paid in BNB" />
      </div>

      <div class="span-2">
        <button class="btn btn-primary" type="submit">Add trade</button>
      </div>
    </form>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <h2>Summary</h2>

    <div class="summary">
      <div class="pill" id="sumTrades">Trades: 0</div>
      <div class="pill" id="sumWinRate">Win rate: 0%</div>
      <div class="pill" id="sumBtc">BTC Result: 0</div>
      <div class="pill" id="sumAvgRoi">Avg ROI: 0%</div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" id="btnPairs" type="button">Pairs summary</button>
      <button class="btn btn-secondary" id="btnExport" type="button">Export JSON</button>
      <label class="btn btn-secondary" for="fileImport" style="display:inline-flex;align-items:center;justify-content:center;">
        Import JSON
      </label>
      <input id="fileImport" type="file" accept="application/json" style="display:none;">
      <button class="btn btn-danger" id="btnReset" type="button">Reset all data</button>
    </div>
  </div>

  <!-- PAIRS SUMMARY -->
  <div class="card" id="pairsCard" style="display:none;">
    <h2>Pairs summary</h2>
    <div class="table-wrap">
      <table id="pairsTable">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Trades</th>
            <th>Wins</th>
            <th>Total BTC</th>
            <th>Avg ROI %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- TRADE HISTORY -->
  <div class="card">
    <h2>Trade history</h2>
    <div class="table-wrap">
      <table id="tradesTable">
        <thead>
          <tr>
            <th>Open</th>
            <th>Close</th>
            <th>Pair</th>
            <th>Qty</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>BTC In</th>
            <th>BTC Out</th>
            <th>BTC Result</th>
            <th>ROI %</th>
            <th>üóëÔ∏è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Data stored locally (localStorage). You are farming sats. üöÄ</div>

  <script>
    // --- Storage keys (KEEP to preserve existing data) ---
    const STORAGE_KEY = "btcPairTrades";

    // ---------- Helpers ----------
    const pad2 = (n) => String(n).padStart(2, "0");

    function formatNumber(n, d = 8) {
      const num = Number(n);
      if (!isFinite(num)) return "0";
      return num.toFixed(d);
    }

    function formatPercent(n) {
      const num = Number(n);
      if (!isFinite(num)) return "0.00%";
      return num.toFixed(2) + "%";
    }

    function loadTrades() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveTrades(trades) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
    }

    // Normalize pair input ‚Üí "XXX/BTC"
    function normalizePair(input) {
      let s = (input || "").trim().toUpperCase();
      s = s.replace(/\s+/g, "");
      if (!s) return "";

      // If user typed "XRPBTC" or "XRP-BTC" or "XRP/BTC"
      s = s.replace(/[-_]/g, "/");
      if (s.includes("/")) {
        const [a, b] = s.split("/");
        if (a && b) {
          if (b === "BTC") return `${a}/BTC`;
          // If user typed BTC/XXX, keep as-is (rare) or flip? We'll keep.
          return `${a}/${b}`;
        }
      }

      // If typed ends with BTC (XRPBTC)
      if (s.endsWith("BTC")) {
        const a = s.slice(0, -3);
        if (a) return `${a}/BTC`;
      }

      // If user typed only "XRP"
      return `${s}/BTC`;
    }

    // Normalize date input to DD/MM/YYYY
    // Accepts: 03122025, 3/12/2025, 03-12-25, 03.12.2025, 2025-12-03
    function normalizeDate(input) {
      let s = (input || "").trim();
      if (!s) return "";

      // yyyy-mm-dd
      const iso = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
      if (iso) {
        const y = iso[1];
        const m = pad2(iso[2]);
        const d = pad2(iso[3]);
        return `${d}/${m}/${y}`;
      }

      // dd-mm-yyyy or dd/mm/yyyy or dd.mm.yyyy
      const dmy = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2}|\d{4})$/);
      if (dmy) {
        const d = pad2(dmy[1]);
        const m = pad2(dmy[2]);
        let y = dmy[3];
        if (y.length === 2) y = "20" + y;
        return `${d}/${m}/${y}`;
      }

      // digits only: ddmmyyyy
      const digits = s.replace(/\D/g, "");
      if (digits.length === 8) {
        const d = digits.slice(0, 2);
        const m = digits.slice(2, 4);
        const y = digits.slice(4, 8);
        return `${d}/${m}/${y}`;
      }

      return ""; // invalid
    }

    // ---------- UI ----------
    const el = (id) => document.getElementById(id);

    function renderPairsSummary(trades) {
      const tbody = el("pairsTable").querySelector("tbody");
      tbody.innerHTML = "";

      const groups = {};
      trades.forEach(t => {
        const p = t.pair || t.par || "";
        if (!p) return;
        if (!groups[p]) groups[p] = { trades: 0, wins: 0, btc: 0, roiSum: 0 };
        groups[p].trades++;
        groups[p].btc += Number(t.btcResult ?? t.btcResultado ?? 0);
        groups[p].roiSum += Number(t.roi ?? t.roiPercent ?? 0);
        if (Number(t.btcResult ?? t.btcResultado ?? 0) > 0) groups[p].wins++;
      });

      const keys = Object.keys(groups).sort();
      if (!keys.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center;color:#6b7280;">No trades</td>`;
        tbody.appendChild(tr);
        return;
      }

      keys.forEach(pair => {
        const g = groups[pair];
        const avgRoi = g.trades ? g.roiSum / g.trades : 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${pair}</td>
          <td>${g.trades}</td>
          <td>${g.wins}</td>
          <td class="${g.btc >= 0 ? "tag-win" : "tag-loss"}">${formatNumber(g.btc)}</td>
          <td class="${avgRoi >= 0 ? "tag-win" : "tag-loss"}">${formatPercent(avgRoi)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function render() {
      const trades = loadTrades();

      // Ensure compatibility with older structure:
      // old: data/par/quantidadeAlt/precoEntrada/precoSaida/taxaBtc/btcEntrada/btcSaida/btcResultado/roiPercent
      // new: openDate/closeDate/pair/qty/entry/exit/fee/btcIn/btcOut/btcResult/roi
      // We'll display whichever exists.

      const tbody = el("tradesTable").querySelector("tbody");
      tbody.innerHTML = "";

      let totalBtc = 0;
      let wins = 0;

      // newest first
      const ordered = [...trades].reverse();

      ordered.forEach((t, revIndex) => {
        const originalIndex = trades.length - 1 - revIndex;

        const open = t.openDate ?? t.open ?? t.data ?? "";
        const close = t.closeDate ?? t.close ?? t.dataFechamento ?? "";
        const pair = t.pair ?? t.par ?? "";
        const qty = t.qty ?? t.quantidadeAlt ?? 0;

        const entry = t.entry ?? t.precoEntrada ?? 0;
        const exit  = t.exit  ?? t.precoSaida ?? 0;

        const btcIn = t.btcIn ?? t.btcEntrada ?? (Number(qty) * Number(entry));
        const btcOut = t.btcOut ?? t.btcSaida ?? (Number(qty) * Number(exit));

        const btcResult = t.btcResult ?? t.btcResultado ?? (Number(btcOut) - Number(btcIn) - Number(t.fee ?? t.taxaBtc ?? 0));
        const roi = t.roi ?? t.roiPercent ?? (Number(btcIn) ? (Number(btcResult) / Number(btcIn)) * 100 : 0);

        totalBtc += Number(btcResult);
        if (Number(btcResult) > 0) wins++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${open || "‚Äî"}</td>
          <td>${close || "‚Äî"}</td>
          <td>${pair || "‚Äî"}</td>
          <td>${formatNumber(qty, 4)}</td>
          <td>${formatNumber(entry)}</td>
          <td>${formatNumber(exit)}</td>
          <td>${formatNumber(btcIn)}</td>
          <td>${formatNumber(btcOut)}</td>
          <td class="${btcResult >= 0 ? "tag-win" : "tag-loss"}">${formatNumber(btcResult)}</td>
          <td class="${roi >= 0 ? "tag-win" : "tag-loss"}">${formatPercent(roi)}</td>
          <td>
            <button class="trash" data-index="${originalIndex}" title="Delete">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      const totalTrades = trades.length;
      const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
      const avgRoi = totalTrades
        ? trades.reduce((acc, t) => acc + Number(t.roi ?? t.roiPercent ?? 0), 0) / totalTrades
        : 0;

      el("sumTrades").textContent = `Trades: ${totalTrades}`;
      el("sumWinRate").textContent = `Win rate: ${winRate.toFixed(2)}%`;
      el("sumBtc").textContent = `BTC Result: ${formatNumber(totalBtc)}`;
      el("sumAvgRoi").textContent = `Avg ROI: ${avgRoi.toFixed(2)}%`;

      // Wire trash buttons
      tbody.querySelectorAll(".trash").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.index);
          if (!Number.isInteger(idx)) return;
          if (!confirm("Delete this trade?")) return;
          const updated = loadTrades();
          updated.splice(idx, 1);
          saveTrades(updated);
          render();
        });
      });

      renderPairsSummary(trades);
    }

    // ---------- Events ----------
    // Silent normalization on blur (minimal UX)
    el("openDate").addEventListener("blur", () => {
      const v = normalizeDate(el("openDate").value);
      if (v) el("openDate").value = v;
    });
    el("closeDate").addEventListener("blur", () => {
      const v = normalizeDate(el("closeDate").value);
      if (v) el("closeDate").value = v;
    });
    el("pair").addEventListener("blur", () => {
      const v = normalizePair(el("pair").value);
      if (v) el("pair").value = v;
    });

    el("tradeForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const openDate = normalizeDate(el("openDate").value);
      const closeDate = normalizeDate(el("closeDate").value);
      const pair = normalizePair(el("pair").value);

      if (!openDate || !closeDate) {
        alert("Please enter valid dates.");
        return;
      }
      if (!pair) {
        alert("Please enter a valid pair.");
        return;
      }

      const qty = parseFloat(el("altQty").value);
      const entry = parseFloat(el("entryPrice").value);
      const exit = parseFloat(el("exitPrice").value);
      const fee = parseFloat(el("feeBtc").value || "0");

      if (![qty, entry, exit].every(v => isFinite(v) && v > 0)) {
        alert("Please fill the required fields.");
        return;
      }

      const btcIn = qty * entry;
      const btcOut = qty * exit;
      const btcResult = btcOut - btcIn - (isFinite(fee) ? fee : 0);
      const roi = btcIn ? (btcResult / btcIn) * 100 : 0;

      const trades = loadTrades();

      // Keep existing trades intact; append new format
      trades.push({
        openDate,
        closeDate,
        pair,
        qty,
        entry,
        exit,
        fee: isFinite(fee) ? fee : 0,
        btcIn,
        btcOut,
        btcResult,
        roi
      });

      saveTrades(trades);

      // reset form (keep placeholders)
      el("tradeForm").reset();

      // set defaults: open date today
      const today = new Date();
      const dd = pad2(today.getDate());
      const mm = pad2(today.getMonth() + 1);
      const yyyy = today.getFullYear();
      el("openDate").value = `${dd}/${mm}/${yyyy}`;

      render();
    });

    el("btnPairs").addEventListener("click", () => {
      const card = el("pairsCard");
      card.style.display = (card.style.display === "none") ? "block" : "none";
    });

    el("btnExport").addEventListener("click", () => {
      const data = loadTrades();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `satoshis-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    el("fileImport").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        if (!Array.isArray(imported)) throw new Error("Invalid file.");

        const mode = confirm("Merge with existing trades?\nOK = Merge\nCancel = Replace");
        const current = loadTrades();
        const next = mode ? current.concat(imported) : imported;

        saveTrades(next);
        render();
      } catch (err) {
        alert("Invalid JSON file.");
      } finally {
        e.target.value = "";
      }
    });

    el("btnReset").addEventListener("click", () => {
      if (!confirm("This will delete all saved trades on this device/browser.\nContinue?")) return;
      localStorage.removeItem(STORAGE_KEY);
      render();
    });

    // Default open date = today
    (function setDefaultDate(){
      const today = new Date();
      const dd = pad2(today.getDate());
      const mm = pad2(today.getMonth() + 1);
      const yyyy = today.getFullYear();
      el("openDate").value = `${dd}/${mm}/${yyyy}`;
    })();

    render();
  </script>
</body>
</html>
